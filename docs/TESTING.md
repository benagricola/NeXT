# NeXT Testing Workflow

This document outlines the process for testing new builds of NeXT on a live machine using the DuetWebControl (DWC) API directly via `curl`.

---

## **CAUTION: LIVE MACHINE TESTING**

**ALL TESTS ARE PERFORMED ON PHYSICAL HARDWARE. EXTREME CAUTION IS REQUIRED.**

Before proceeding with any test, you must ensure:
1.  The machine is in a safe, known state.
2.  No tools are in the spindle unless specifically required for the test.
3.  The work area is clear of all obstructions.
4.  You are physically present and ready to perform an emergency stop at any time.

---

## Live Testing Rules and Operator Confirmation

1.  **Explicit Confirmation Required:** A live test **MUST NOT** be run unless the user has explicitly confirmed that it is safe to do so. The agent must ask for confirmation before initiating any test that moves the machine.

2.  **Exception for Repetitive Testing:** The only situation where the confirmation requirement can be bypassed is if the same macro is being run multiple times in a sequence for testing purposes. This is only permitted if the agent can guarantee that the machine has been returned to its original starting position before each re-execution of the macro.

3.  **Test Sparingly:** Live tests should be used judiciously. The machine is not always available, and operator attendance is required. Tests should be grouped and run efficiently to minimize machine-on time.

4.  **Pre-Pull Request Validation:** The ideal time to run live tests is when a feature is considered complete, but *before* creating a pull request. This allows for the capture and resolution of simple or obvious errors that only appear during live execution, ensuring a cleaner and more stable pull request.

---

## 1. Prerequisites

*   **Duet IP Address:** The IP address of the Duet board on the local network (referred to as `<DUET_IP>`).
*   **Release Package:** A `millennium-os.zip` release package generated by the project's build scripts.

---

## 2. Testing Workflow

The standard workflow for testing a new feature or build consists of four main steps:

#### **Step 1: Build and Package a Release**
*   Ensure the feature branch is up-to-date and all code is committed.
*   Run the project's designated build script (e.g., `npm run build` or similar) to create the `millennium-os.zip` package in the `dist/` directory.

#### **Step 2: Upload and Install the Release**
*   The new release package is uploaded to the Duet board via a `curl` POST request.
*   Once uploaded, an M-code is sent to have the firmware extract and install the plugin and macro files.

#### **Step 3: Execute Test G-code**
*   Specific G-code commands are sent to the machine via `curl` to test the new functionality.
*   This can range from simple commands like `G28` (Homing) to complex macro calls like `G6508` (Outside Corner Probe).

#### **Step 4: Verify Results and Check for Errors**
*   After sending a command, the DWC reply buffer is polled using `curl`.
*   The response is inspected for any error messages generated by RepRapFirmware or custom error messages from MillenniumOS macros.
*   The machine's object model can also be queried to verify that state changes (e.g., updated WCS offsets) have occurred as expected.

---

## 3. Core `curl` Commands

These are the fundamental commands used for interacting with the DWC API.

#### **Uploading a Release**

This command uploads the packaged `.zip` file to the `/sys/` directory on the Duet's SD card.

```bash
curl -X POST --data-binary @"dist/millennium-os.zip" "http://<DUET_IP>/rr_upload?name=0:/sys/millennium-os.zip"
```

#### **Installing a Release**

After uploading, this command tells the firmware to extract the contents of the zip file. `S2` indicates a system file update.

```bash
curl "http://<DUET_IP>/rr_gcode?gcode=M997 S2"
```
*Note: After installation, the board will restart. You will need to wait for it to come back online.* 

#### **Sending G-code**

This command sends a G-code string to be executed by the machine. The G-code must be URL-encoded.

```bash
# Example: Homing the machine
curl "http://<DUET_IP>/rr_gcode?gcode=G28"

# Example: Running a probing cycle (ensure G-code is properly encoded)
curl "http://<DUET_IP>/rr_gcode?gcode=G6508%20Q1%20N0%20T10%20O5%20J100%20K100%20L-5%20Z-10"
```

#### **Checking for Replies and Logs**

This command fetches the plain text reply buffer from the firmware, which contains recent console messages, command responses, and errors.

```bash
curl "http://<DUET_IP>/rr_reply"
```
*   **Verification:** The output of this command must be parsed to check for strings like `Error:`, `Warning:`, or specific success/failure messages from MillenniumOS macros.
